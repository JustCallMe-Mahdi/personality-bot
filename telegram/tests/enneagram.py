from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from aiogram.fsm.state import StatesGroup, State
from aiogram.fsm.context import FSMContext
from db.database import get_user_full_profile
from tests.enneagram_types.enneagram_types import get_enneagram_type_description

router = Router()

def enneagram_menu_keyboard() -> InlineKeyboardMarkup:
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="๐นุณุงุฏู (18 ุณูุงู)", callback_data="enneagram_simple_start"),
        InlineKeyboardButton(text="๐ธูพุดุฑูุชู (45 ุณูุงู)", callback_data="enneagram_advanced")],
        [InlineKeyboardButton(text="๐ ุฑูููุง", callback_data="enneagram_guide"),
        InlineKeyboardButton(text="๐ ุขุดูุง ุจุง ุชูพ ูุง", callback_data="enneagram_types")],
        [InlineKeyboardButton(text="๐ ุจุงุฒฺฏุดุช", callback_data="back_to_tests")]
    ])
    return keyboard

main_menu = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="๐ง ุชุณุช ูุง")],
        [KeyboardButton(text="๐ฌ ฺุช ูุงุดูุงุณ (ุจู ุฒูุฏ)"), KeyboardButton(text="๐ฒ ุณุฑฺฏุฑู ู ุชุณุช ูุงู (ุจู ุฒูุฏ)")],
        [KeyboardButton(text="๐ฅ ููู ู ูุฏุง (ุจู ุฒูุฏ)"),KeyboardButton(text="๐ค ูพุฑููุงู")],
        [KeyboardButton(text="๐๏ธ ฺุงูุด ุฑูุฒุงูู (ุจู ุฒูุฏ)"), KeyboardButton(text="๐ ูฺฉโุจุงุช (ุจู ุฒูุฏ)")],
        [KeyboardButton(text="๐ ุฑุชุจูโุจูุฏ (ุจู ุฒูุฏ)"), KeyboardButton(text="๐ ฺฉู ูพูู (ุจู ุฒูุฏ)") , KeyboardButton(text="๐ ูพุดุชุจุงู")]
    ],
    resize_keyboard=True,
    input_field_placeholder="ฺฉ ฺฏุฒูู ุฑู ุงูุชุฎุงุจ ฺฉู..."
)


tests_menu = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="๐ง ุชุณุชโูุง ุดุฎุตุช")],
        [KeyboardButton(text="๐ ุชุณุชโูุง ุฑูุงูโุฏุฑูุงู (ุจู ุฒูุฏ)"), KeyboardButton(text="๐ง ุชุณุชโูุง ููุด (ุจู ุฒูุฏ)")],
        [KeyboardButton(text="๐ค ุชุณุชโูุง ุฑูุชุงุฑ (ุจู ุฒูุฏ)"), KeyboardButton(text="โค๏ธ ุชุณุชโูุง ุฑูุงุจุท (ุจู ุฒูุฏ)")],
        [KeyboardButton(text="๐ ุจุงุฒฺฏุดุช ุจู ููู ุงุตู")],
    ],
    resize_keyboard=True,
    input_field_placeholder="ฺู ููุน ุชุณุช ูุฎูุง ุจุฒูุ..."
)


@router.callback_query(F.data == "back_to_tests")
async def back_to_tests(callback: CallbackQuery):
    user_id = callback.from_user.id
    profile = get_user_full_profile(user_id)

    if profile:
        name = profile[1]
        await callback.message.answer(
            f"ูุง ุงูุฌุง ุงููุงุน ุชุณุช ูุงุฑู ุฏุงุฑู {name} ุฌุงู! ฺฉุฏูู ุฑู ุงูุชุฎุงุจ ูฺฉูุ",
            reply_markup=tests_menu
        )
    else:
        await callback.message.answer("โ ุงูู ุจุงุฏ ูพุฑููุงูุชู ุจุณุงุฒ. ูุทูุงู /start ุฑู ุจุฒู.")


@router.callback_query(F.data == "enneagram_menu")
async def enneagram_menu_handler(callback: CallbackQuery):
    text = (
        """<b>๐ง ุชุณุช ุดุฎุตุช Enneagram: ูุงูโ ูพููุงู ุดุฎุตุชุช ุฑู ุจุดูุงุณ!</b>
ุงู ุชุณุช ฺฉ ุงุฒ ุนููโุชุฑู ุชุณุชโูุง ุดุฎุตุชโุดูุงุณ ุฏูุงุณุช.
ุงูุงฺฏุฑุงู ฺฉูฺฉ ูโฺฉูู ุจููู ฺุฑุง ูุงูุนุงู ุงููโุฌูุฑ ุฑูุชุงุฑ ูโฺฉู ฺฉู ูโฺฉู โ ูู ููุท ฺุทูุฑ!

๐ฏ ูุฑุงุฑู ุจุง ุชุฑุณโูุง ูพููุงูุ ุงูฺฏุฒูโูุง ุฏุฑููุ ููุงุท ููุช ู ุญุช ูุณุฑ ุฑุดุฏ ุดุฎุตุชุช ุขุดูุง ุจุด.
ฺฉุงูู ููุท ุงูุชุฎุงุจ ฺฉู:"""
    )

    await callback.message.edit_text(
        text,
        reply_markup=enneagram_menu_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()


def enneagram_guide_keyboard() -> InlineKeyboardMarkup:
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="๐น ุดุฑูุน ุชุณุช ุณุงุฏู", callback_data="enneagram_simple_start"),
        InlineKeyboardButton(text="๐ธ ุดุฑูุน ุชุณุช ูพุดุฑูุชู", callback_data="enneagram_advanced")],
        [InlineKeyboardButton(text="๐ ุขุดูุง ุจุง น ุชูพ", callback_data="enneagram_types")],
        [InlineKeyboardButton(text="๐ ุจุงุฒฺฏุดุช", callback_data="enneagram_menu")]
    ])
    return keyboard


def get_all_types_keyboard() -> InlineKeyboardMarkup:
    keyboard = []
    for i in range(1, 10):
        keyboard.append([
            InlineKeyboardButton(
                text=f"{i}๏ธโฃ ุชูพ {i}",
                callback_data=f"show_type_{i}"
            )
        ])
    keyboard.append([
        InlineKeyboardButton(text="๐ ุจุงุฒฺฏุดุช", callback_data="enneagram_menu")
    ])
    return InlineKeyboardMarkup(inline_keyboard=keyboard)


@router.callback_query(F.data == "enneagram_types")
async def show_all_types(callback: CallbackQuery):
    await callback.message.edit_text(
        "๐ <b>ุขุดูุง ุจุง น ุชูพ ุดุฎุตุช ุงูุงฺฏุฑุงู</b>\n\n"
        "ุฑู ูุฑ ฺฉุฏูู ฺฉูฺฉ ฺฉู ุชุง ุชูุถุญุงุช ุงูู ุชูพ ุฑู ุจุจู:",
        parse_mode="HTML",
        reply_markup=get_all_types_keyboard()
    )
    await callback.answer()

@router.callback_query(F.data.startswith("show_type_"))
async def show_type_detail(callback: CallbackQuery):
    type_num = int(callback.data.split("_")[-1])
    desc = get_enneagram_type_description(type_num)

    await callback.message.edit_text(
        f"<b>ุชูพ {type_num}</b>\n\n{desc}",
        parse_mode="HTML",
        reply_markup=get_all_types_keyboard()
    )
    await callback.answer()


@router.callback_query(F.data == "enneagram_guide")
async def enneagram_guide_handler(callback: CallbackQuery):
    text = ("""
<b>    ๐ ุฑุงูููุง ุชุณุช ุงูุงฺฏุฑุงู</b>

ุชุณุช ุงูุงฺฏุฑุงู ฺฉ ุงุฒ ูุนุฑููโุชุฑู ุงุจุฒุงุฑูุง ุฎูุฏุดูุงุณ ุฏุฑ ุฏูุงุณุช.

ุจุฑุฎูุงู ุชุณุชโูุง ูุซู MBTI ฺฉู ุจูุช ูโฺฏู "ฺู ุฑูุชุงุฑ ุฏุงุฑ"ุ ุงูุงฺฏุฑุงู ฺฉูฺฉ ูโฺฉูู ุจููู:
๐ญ ฺุฑุง ุงู ุฑูุชุงุฑ ุฑู ุฏุงุฑุ
๐จ ฺู ุชุฑุณ ูพุดุช ุฑูุชุงุฑูุงุช ูพููุงููุ
๐ฏ ู ฺู ฺุฒ ูุงูุนุงู ุชู ุฑู ุงุฒ ุฏุฑูู ูุฏุงุช ูโฺฉูู.

๐ข ุชู ุงู ุชุณุชุ ูุฑ ฺฉุณ ุจู ฺฉ ุงุฒ น ุชูพ ุดุฎุตุช ุงุตู ูุฒุฏฺฉโุชุฑู:
ุงูุง ูููโ ูุง ุชุฑฺฉุจ ุงุฒ ฺูุฏ ุชูพ ูุณุชู.

โจ ูุฑ ุชูพ:
โข ฺฉ ุชุฑุณ ุจูุงุฏู ุฏุงุฑู
โข ฺฉ ุงูฺฏุฒูโ ุฏุฑูู ูู
โข ฺฉ ูุณุฑ ุจุฑุง ุฑุดุฏ ูุฑุฏ

๐ ุชู ูุณุฎูโ ูพุดุฑูุชูโ ุชุณุช ุญุช:
โข ุชูพโูุง ูุฑุน (ุจุงูโูุง)
โข ูุณุฑ ุฑุดุฏ (integration)
โข ูุณุฑ ูุดุงุฑ (disintegration)
ูู ุจุฑุฑุณ ูโุดู!

ุงฺฏุฑ ุฏูุจุงู ฺฉ ุฎูุฏุดูุงุณ ูุงูุน ู ุนูู ูุณุชุ ุงู ุชุณุช ุจูุช ฺฉูฺฉ ูโฺฉูู ุจููู ูุงูุนุงู ฺฉ ูุณุชโฆ ู ฺูโุทูุฑ ูโุชูู ุจูุชุฑ ุจุด."""
    )

    await callback.message.edit_text(
        text,
        reply_markup=enneagram_guide_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()




simple_enneagram_questions = {
    1: {
        "text": "ูู ููุดู ุชูุงุด ูโฺฉูู ุฏุฑุณุช ู ุงุฎูุงู ุฑูุชุงุฑ ฺฉููุ ุญุช ููุช ฺฉุณ ููโุจูู.",
        "related_type": 1  # ุงุตูุงุญโฺฏุฑ
    },
    2: {
        "text": "ููุช ฺฉุณ ฺฉุงุฑ ุฑู ุงุดุชุจุงู ุงูุฌุงู ูโุฏูุ ฺฉูุชุฑู ุฎูุฏูู ุณุฎุช ุญูุธ ูโฺฉูู.",
        "related_type": 1
    },
    3: {
        "text": "ูู ูุงุฒ ุฏุงุฑู ุงุญุณุงุณ ฺฉูู ุฏฺฏุฑุงู ูุงูุนุงู ุจู ูู ูุงุฒ ุฏุงุฑู.",
        "related_type": 2  # ุงุฑโฺฏุฑ
    },
    4: {
        "text": "ุงฺฏู ฺฉุณ ุงุฒู ุชุดฺฉุฑ ูฺฉููุ ููฺฉูู ูุงุฑุงุญุช ุจุดู ุญุช ุงฺฏู ฺฉูฺฉ ฺฉุฑุฏู ุจุฑุงู ูููโุชุฑ ุจูุฏู.",
        "related_type": 2
    },
    5: {
        "text": "ุฑุณุฏู ุจู ููููุช ู ุฏุฏู ุดุฏู ุจุฑุงู ุฎู ูููู.",
        "related_type": 3  # ููููโุทูุจ
    },
    6: {
        "text": "ุฏูุณุช ุฏุงุฑู ุฏฺฏุฑุงู ููู ุชุญุณู ฺฉููุ ุญุช ุงฺฏู ููุด ฺฉูฺฺฉ ุจุงุฒ ฺฉุฑุฏู ุจุงุดู.",
        "related_type": 3
    },
    7: {
        "text": "ุงุญุณุงุณ ูโฺฉูู ุจุง ุจูู ูุฑู ุฏุงุฑู ู ุฏูุจุงู ูุนูุง ุฎุงุต ุจุฑุง ุฒูุฏฺฏโุงู ูุณุชู.",
        "related_type": 4  # ูุฑุฏฺฏุฑุง
    },
    8: {
        "text": "ฺฏุงู ุงุญุณุงุณุงุช ูโุดู ูู ููโุฎูุงู ฺฉุณ ูุชูุฌู ุจุดู.",
        "related_type": 4
    },
    9: {
        "text": "ูู ูุนูููุงู ุชุฑุฌุญ ูโุฏู ุชููุง ุจุงุดู ุชุง ุงูฺฉู ุฏุฑ ุฌูุน ูุฑุงุฑ ุจฺฏุฑู ฺฉู ูุฌุจูุฑ ุจู ุชุนุงูู ุจุงุดู.",
        "related_type": 5  # ูุชูฺฉุฑ
    },
    10: {
        "text": "ุฎู ููุชโูุง ูุจู ุงุฒ ุดุฑูุน ฺฉุงุฑุ ูุงุฒ ุฏุงุฑู ุงูู ูููโฺ ุฑู ุฎูุจ ุจูููู.",
        "related_type": 5
    },
    11: {
        "text": "ูู ุฎู ูุญุชุงุท ู ูุฑุงูุจู ฺฉู ุจู ฺฉุณ ุง ฺุฒ ุงุนุชูุงุฏ ูฺฉูู ุจโุฏูู.",
        "related_type": 6  # ููุงุฏุงุฑ/ุดฺฉุงฺฉ
    },
    12: {
        "text": "ููุช ุชุตูู ููู ุฏุงุฑูุ ุงุบูุจ ุฏฺุงุฑ ุดฺฉ ู ุฏูุฏู ูโุดู.",
        "related_type": 6
    },
    13: {
        "text": "ูู ููุดู ุฏูุจุงู ุชุฌุฑุจูโูุง ุฌุฏุฏ ู ูุฌุงูโุงูฺฏุฒู.",
        "related_type": 7  # ุฎูุดโฺฏุฐุฑุงู
    },
    14: {
        "text": "ุงุฒ ุงูฺฉู ุฒูุงูู ุตุฑู ฺฉุงุฑูุง ุชฺฉุฑุงุฑ ุจุดูุ ูุงูุนุงู ูุงุฑุงุญุช ูโุดู.",
        "related_type": 7
    },
    15: {
        "text": "ููุช ุดุฑุงุท ุณุฎุช ูโุดูุ ุฎูุฏู ูุณุฆููุช ุฑู ุจูโุฏุณุช ูโฺฏุฑู.",
        "related_type": 8  # ุฑูุจุฑ/ฺุงูุดโฺฏุฑ
    },
    16: {
        "text": "ููโุฐุงุฑู ฺฉุณ ุงุฒู ุณูุกุงุณุชูุงุฏู ฺฉููุ ุญุช ุงฺฏู ุฏุนูุง ุจุดู.",
        "related_type": 8
    },
    17: {
        "text": "ุงุฒ ุฏุฑฺฏุฑ ุจุฏู ูุงุฏ ู ุชุฑุฌุญ ูโุฏู ููุดู ุตูุญ ุจุฑูุฑุงุฑ ุจุงุดู.",
        "related_type": 9  # ุตูุญโุทูุจ
    },
    18: {
        "text": "ฺฏุงู ุฎูุฏู ุฑู ูุฑุงููุด ูโฺฉูู ููุท ุจุฑุง ุงูฺฉู ุจูู ุงุฐุช ูุดู.",
        "related_type": 9
    }
}




simple_type_descriptions = {
    1: "๐ง ฺฉูุงูโฺฏุฑุงุ ุงุตููโูุญูุฑุ ุงุฎูุงู\n"
       "ุฏูุจุงู ุฏุฑุณุชโฺฉุงุฑ ู ุจูุจูุฏ ุฏูุงุณุช. ฺฏุงู ุฒุงุฏ ุณุฎุชโฺฏุฑ ูโุดูุ ูุฎุตูุตุงู ูุณุจุช ุจู ุฎูุฏุด.\n"
       "ูุฌุฏุงู ูู ุฏุงุฑู ู ุชูุงุด ูโฺฉูู ุงุฒ ุฎุทุง ุฏูุฑ ฺฉูู.",

    2: "โค๏ธ ููุฑุจุงูุ ุฏูุณูุฒุ ูุฏุงฺฉุงุฑ\n"
       "ุนููุงู ูุงุฒ ุจู ุฏูุณุช ุฏุงุดุชู ุดุฏู ุฏุงุฑู. ุจุง ฺฉูฺฉ ุจู ุฏฺฏุฑุงู ุงุญุณุงุณ ุงุฑุฒุด ูโฺฉูู.\n"
       "ูู ููฺฉูู ูุงุฒูุง ุฎูุฏุด ุฑู ูุงุฏุฏู ุจฺฏุฑู.",

    3: "๐ ุจููุฏูพุฑูุงุฒุ ูุฏูโฺฏุฑุงุ ุนููโฺฏุฑุง\n"
       "ุฏูุจุงู ุฏุฏู ุดุฏู ู ููููุชู. ุจุฑุง ุฑุณุฏู ุจู ููููุชุ ูุฑ ุชูุงุด ูโฺฉูู.\n"
       "ฺฏุงู ุชุตูุฑ ุงุฒ ุฎูุฏุด ูโุณุงุฒู ฺฉู ูุงูุน ูุณุช.",

    4: "๐จ ุฎูุงูุ ุงุญุณุงุณุ ููุญุตุฑโุจูโูุฑุฏ\n"
       "ุฏูุจุงู ูุนูุง ู ููุช ุฎุงุต ุฎูุฏุดู. ุนููุงู ุงุญุณุงุณุงุช ู ุญุณุงุณู.\n"
       "ฺฏุงู ุฏุฑ ุญุณ ูุชูุงูุช ุจูุฏู ุบุฑู ูโุดู.",

    5: "๐งฉ ุชุญููโฺฏุฑุ ฺฉูุฌฺฉุงูุ ูุณุชูู\n"
       "ุนูุงููโููุฏ ุจู ููู ุนูู ููุงูู ู ุงุฏูโูุงุณุช. ุงุฒ ุฎุงู ุดุฏู ุงูุฑฺ ุฎูุฏุด ูโุชุฑุณู.\n"
       "ฺฏุงู ุงุฒ ุชุนุงููุงุช ุงุฌุชูุงุน ูุงุตูู ูโฺฏุฑู.",

    6: "๐ก ูุญุชุงุทุ ููุงุฏุงุฑุ ูุณุฆููุชโูพุฐุฑ\n"
       "ุฏูุจุงู ุงููุช ู ุงุนุชูุงุฏ ูุงุจู ุงุชฺฉุงุณุช. ุณูุงูุงุช ุฒุงุฏ ูโูพุฑุณู ู ููุดู ุฏูุจุงู ูพุดุชุจุงูู.\n"
       "ูู ููฺฉูู ุฏฺุงุฑ ุดฺฉ ู ุชุฑุฏุฏ ุฒุงุฏ ุจุดู.",

    7: "๐ ูพุฑุงูุฑฺุ ูุดุชุงูุ ุฎูุงู\n"
       "ุฏูุจุงู ุขุฒุงุฏุ ุชุฌุฑุจูโูุง ุฌุฏุฏ ู ูุฐุชโุจุฑุฏูู. ุงุฒ ูุญุฏูุฏ ุดุฏู ู ุฏุฑุฏูุง ุฏุฑูู ูุฑุงุฑู.\n"
       "ฺฏุงู ุงุฒ ุชุนูุฏูุง ุฌุฏ ุทูุฑู ูโุฑู.",

    8: "๐ฅ ููุ ูุณุชููุ ูุงุทุน\n"
       "ุงุฒ ฺฉูุชุฑู ุดุฏู ูุชููุฑู ู ุฎูุฏุด ฺฉูุชุฑูโฺฏุฑู. ุฏูุจุงู ุนุฏุงูุช ู ูุฏุฑุช ูุงูุน ุจุฑุง ูุญุงูุธุช ุงุฒ ุฎูุฏุดู.\n"
       "ฺฏุงู ุจุด ุงุฒ ุญุฏ ุชูุฏ ุง ุณูุทูโฺฏุฑ ูโุดู.",

    9: "๐ฟ ุขุฑุงูุ ูพุฐุฑูุฏูุ ููุงููฺฏ\n"
       "ุงุฒ ุชูุด ู ุฏุฑฺฏุฑ ูุฑุงุฑู. ุฏูุจุงู ุขุฑุงูุดุ ุชุนุงุฏู ู ุตูุญ ุจุง ูููโุณุช.\n"
       "ูู ููฺฉูู ุฎูุฏุด ุฑู ูุฑุงููุด ฺฉูู ุง ุชุตููโฺฏุฑ ุฑู ุจู ุชุฃุฎุฑ ุจูุฏุงุฒู.",
}




def get_enneagram_start_options() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text="โ ุชุณุช ุณุงุฏู (ุณุฑุน)", callback_data="enneagram_simple"
        )],
        [InlineKeyboardButton(
            text="๐ ุชุณุช ูพุดุฑูุชู (ุฏูู)", callback_data="enneagram_advanced"
        )],
        [InlineKeyboardButton(
            text="๐ ุจุงุฒฺฏุดุช", callback_data="enneagram_menu"
        )]
    ])


@router.callback_query(F.data == "enneagram_simple_start")
async def send_enneagram_intro(callback: CallbackQuery):
    await callback.message.edit_text(
        text=(
            "๐ง <b>ุชุณุช ุณุงุฏู Enneagram</b>\n\n"
            "ุงู ู ูุณุฎูโ ฺฉูุชุงู ู ุณุฑุน ุงุฒ ุชุณุช ุดุฎุตุช ุงูุงฺฏุฑุงูู.\n"
            "ุจุง ููุท ฑธ ุณูุงูุ ูโุชููู ู ุฏุฏ ุงููู ุงุฒ ุชูพ ุดุฎุตุชุช ุจุฏูุ "
            "ุงูุง ุฏูุช ุงู ูุณุฎู ุญุฏูุฏุงู <b>ถฐูช</b> ูู ู ุจุฑุง ุชุญูู ุนูู ฺฉุงู ูุณุช.\n\n"
            "ุงฺฏู ูโุฎูุง ุจุฏูู:\n"
            "๐ธ ุดุจู ฺฉุฏูู ุชูพโูุง ุฏฺฏู ูู ูุณุชุ\n"
            "๐ธ ููุงุท ุฑุดุฏ ู ฺุงูุดโูุงุช ฺูุ\n"
            "๐ธ ูุณุฑ ุชูุณุนูโ ุดุฎุตุชุช ฺุทูุฑูุ\n\n"
            "๐ ุชุณุช ูพุดุฑูุชู ุฑู ุจุฒู ฺฉู ุจุง ุจุด ุงุฒ ตฐ ุณูุงูุ ุชุญูู ุฏููโุชุฑ ุจูุช ูโุฏู.\n\n"
            "<b>ูโุฎูุง ฺฉุฏูู ุฑู ุดุฑูุน ฺฉูุ</b>"
        ),
        parse_mode="HTML",
        reply_markup=get_enneagram_start_options()
    )
    await callback.answer()


class SimpleEnneagramTest(StatesGroup):
    question = State()





@router.callback_query(F.data == "enneagram_simple")
async def start_simple_enneagram(callback: CallbackQuery, state: FSMContext):
    await state.set_state(SimpleEnneagramTest.question)
    await state.update_data(current_q=1, scores={i: 0 for i in range(1, 10)})

    await send_enneagram_question(callback.message, state)
    await callback.answer()

def get_progress_bar(current, total):
    filled = int((current / total) * 10)
    return "โ" * filled + "โ" * (10 - filled) + f" {int(current/total*100)}ูช"

def get_question_keyboard(q_id: int) -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
         [InlineKeyboardButton(text="๐ขโ ฺฉุงููุงู ููุงูู", callback_data=f"answer:{q_id}:5")],
        [InlineKeyboardButton(text="๐ข ููุงูู", callback_data=f"answer:{q_id}:4")],
        [InlineKeyboardButton(text="๐ก ุจโูุธุฑ", callback_data=f"answer:{q_id}:3")],
         [InlineKeyboardButton(text="๐ ูุฎุงูู", callback_data=f"answer:{q_id}:2")],
        [InlineKeyboardButton(text="๐ด ฺฉุงููุงู ูุฎุงูู", callback_data=f"answer:{q_id}:1")],
    ])


async def send_enneagram_question(message: Message, state: FSMContext):
    data = await state.get_data()
    current_q = data["current_q"]
    question_data = simple_enneagram_questions[current_q]

    progress = get_progress_bar(current_q, len(simple_enneagram_questions))

    await message.edit_text(
        f"๐ง ุชุณุช ุดุฎุตุช Enneagram (ุณุงุฏู)\n"
        f"โ ุณูุงู {current_q} ุงุฒ 18\n\n"
        f"๐ฌ <b>{question_data['text']}</b>\n\n"
        f"๐ ูพุดุฑูุช: {progress}\n\n"
        f"๐ ูพุงุณุฎโุช ุฑู ุงูุชุฎุงุจ ฺฉู:",parse_mode="HTML",
        reply_markup=get_question_keyboard(current_q)
    )

@router.callback_query(F.data.startswith("answer:"), SimpleEnneagramTest.question)
async def handle_answer(callback: CallbackQuery, state: FSMContext):
    parts = callback.data.split(":")
    q_id = int(parts[1])
    score = int(parts[2])

    question_data = simple_enneagram_questions[q_id]
    related_type = question_data["related_type"]

    data = await state.get_data()
    scores = data["scores"]
    scores[related_type] += score

    current_q = data["current_q"] + 1

    if current_q > len(simple_enneagram_questions):
        await show_enneagram_result(callback, scores)
        await state.clear()
    else:
        await state.update_data(current_q=current_q, scores=scores)
        await send_enneagram_question(callback.message, state)

    await callback.answer()


def get_simple_result_keyboard(dominant_type: int) -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text="๐ ุฏุฑุจุงุฑู ุชูพ ูู ุจุดุชุฑ ุจุฏููู",
            callback_data=f"show_type_{dominant_type}"
        )],
        [InlineKeyboardButton(
            text="๐ ุฑูุชู ุจู ุชุณุช ูพุดุฑูุชู",
            callback_data="enneagram_advanced_start"
        ),
        InlineKeyboardButton(
            text="๐ ุขุดูุง ุจุง ููู ุชูพโูุง",
            callback_data="enneagram_types"
        )],
        [InlineKeyboardButton(
            text="๐ ุจุงุฒฺฏุดุช",
            callback_data="back_to_tests"
        )],
    ])

async def show_enneagram_result(callback: CallbackQuery, scores: dict):
    dominant_type = max(scores, key=scores.get)
    score = scores[dominant_type]

    type_names = {
        1: "ุชูพ 1 - ุงุตูุงุญโฺฏุฑ",
        2: "ุชูพ 2 - ุงุฑโฺฏุฑ",
        3: "ุชูพ 3 - ููููโุทูุจ",
        4: "ุชูพ 4 - ูุฑุฏฺฏุฑุง",
        5: "ุชูพ 5 - ูุชูฺฉุฑ",
        6: "ุชูพ 6 - ููุงุฏุงุฑ",
        7: "ุชูพ 7 - ุฎูุดโฺฏุฐุฑุงู",
        8: "ุชูพ 8 - ุฑูุจุฑ",
        9: "ุชูพ 9 - ุตูุญโุทูุจ",
    }

    desc = simple_type_descriptions[dominant_type]

    await callback.message.edit_text(
        f"โ ุชุณุช ุชููู ุดุฏ!\n\n"
        f"๐ฏ ุชูพ ุดุฎุตุช ุดูุง: <b>{type_names[dominant_type]}</b>\n"
        f"๐งฎ ูุฌููุน ุงูุชุงุฒ: {score}\n\n"
        f"{desc}\n\n"
        f"โจ ุญุงูุง ูโุชูู:\n"
        f"๐น ุงุทูุงุนุงุช ฺฉุงููโุชุฑ ุงุฒ ุงู ุชูพ ุจุจู\n"
        f"๐ธ ุชุณุช ูพุดุฑูุชู ุฑู ุจุฒู\n"
        f"๐ ุจูู ุชูพโูุง ุฑู ูู ูุฑูุฑ ฺฉู"
        ,
        parse_mode="HTML",
        reply_markup=get_simple_result_keyboard(dominant_type)
    )












# ------------- ุชุณุช ูพุดุฑูุชู ___________________


advanced_enneagram_questions = {
    1: "ูู ูุนูููุงู ุฏุฑ ุชูุงุด ูุณุชู ููู ฺุฒ ุฑู ุฏุฑุณุชุ ููุธู ู ุงุฎูุงู ุงูุฌุงู ุจุฏู.",
    2: "ุฎูุดุญุงู ูโุดู ููุช ูโุชููู ุจู ุจูู ฺฉูฺฉ ฺฉููุ ุญุช ุงฺฏุฑ ุฎูุฏู ุฎุณุชู ุจุงุดู.",
    3: "ูู ุชูุงู ุฏุงุฑู ฺฉู ุฎูุฏู ุฑู ูููู ู ุชูุงูุง ูุดูู ุจุฏู.",
    4: "ฺฏุงู ุงุญุณุงุณ ูโฺฉูู ูฺโฺฉุณ ูุงูุนุงู ููู ููโูููู.",
    5: "ููุชู ุฑู ุจุดุชุฑ ุตุฑู ูฺฉุฑ ฺฉุฑุฏู ู ุชุญูู ฺฉุฑุฏู ูโฺฉูู ุชุง ุงุฑุชุจุงุท ุจุง ุขุฏูโูุง.",
    6: "ูู ุงุบูุจ ูฺฏุฑุงู ุขูุฏู ู ุงุชูุงูุงุช ุบุฑููุชุธุฑู ูุณุชู.",
    7: "ูู ููุดู ุฏูุจุงู ุชุฌุฑุจูโูุง ุฌุฏุฏ ู ูุฌุงูโุงูฺฏุฒู.",
    8: "ูู ุชุฑุฌุญ ูโุฏู ฺฉูุชุฑู ุงูุถุงุน ุฏุณุช ุฎูุฏู ุจุงุดู.",
    9: "ูู ูุนูููุงู ุณุน ูโฺฉูู ุงุฒ ุฏุฑฺฏุฑ ู ุชูุด ุฏูุฑ ฺฉูู.",
    10: "ูู ุงุฒ ุงุดุชุจุงู ฺฉุฑุฏู ุงุญุณุงุณ ฺฏูุงู ูโฺฉูู.",
    11: "ฺฏุงู ูุงุฒูุง ุฏฺฏุฑุงู ุจุฑุงู ูููโุชุฑ ุงุฒ ูุงุฒูุง ุฎูุฏูู.",
    12: "ูู ุฒุงุฏ ุจู ุงูุฏุงูู ูฺฉุฑ ูโฺฉูู ู ุจุฑุง ุฑุณุฏู ุจูุดูู ุชูุงุด ูโฺฉูู.",
    13: "ูู ูุณุจุช ุจู ุงุญุณุงุณุงุชู ุญุณุงุณู ู ุจูโุณุงุฏฺฏ ุชุญุชโุชุฃุซุฑ ูุฑุงุฑ ูโฺฏุฑู.",
    14: "ุชุฑุฌุญ ูโุฏู ุจุดุชุฑ ุงุฒ ุฏูุฑ ุจู ูุณุงุฆู ูฺฏุงู ฺฉูู ุชุง ุฏุฑฺฏุฑุดูู ุจุดู.",
    15: "ุงฺฏุฑ ุจุฑูุงููโุง ูุฏุงุดุชู ุจุงุดูุ ูุถุทุฑุจ ูโุดู.",
    16: "ูู ูุนูููุงู ููโุฐุงุฑู ุดุฑุงุท ุชฺฉุฑุงุฑ ุง ุฎุณุชูโฺฉููุฏู ุจุดู.",
    17: "ููุช ุชูุฏุฏ ุง ุธูู ุจุจููุ ุณุฑุน ูุงฺฉูุด ูุดูู ูโุฏู.",
    18: "ูู ุงุบูุจ ุฎูุฏู ุฑู ุจุง ุดุฑุงุท ููู ูโุฏู ุชุง ุงุฒ ุชูุด ุฌููฺฏุฑ ฺฉูู.",
    19: "ูู ุงุบูุจ ุจู ุฌุฒุฆุงุช ุงููุช ูโุฏู ู ุชูุงุด ูโฺฉูู ุจโููุต ุจุงุดู.",
    20: "ุจุฑุง ูู ูููู ฺฉู ุจูู ููู ุจูโุนููุงู ูุฑุฏ ููุฑุจูู ู ููุฏ ุจุจูู.",
    21: "ูู ุฎู ุงูู ุฑูุงุจุช ู ุฑุณุฏู ุจู ุณุทุญ ุจุงูุงู.",
    22: "ฺฏุงู ุงุญุณุงุณ ูโฺฉูู ุจุง ุจูู ูุฑู ุฏุงุฑู.",
    23: "ูู ุนูุงูู ุฏุงุฑู ูุณุชูู ุจุงุดู ู ุฒุงุฏ ุงุฒ ุจูู ฺฉูฺฉ ููโฺฏุฑู.",
    24: "ููุช ุจู ฺุฒ ูุดฺฉูฺฉูุ ุฏูู ููโุฎูุงุฏ ุจู ุฑุงุญุช ุงุนุชูุงุฏ ฺฉูู.",
    25: "ุงฺฏุฑ ุงุญุณุงุณ ฺฉูู ุญูุตููโู ุณุฑ ุฑูุชูุ ุณุฑุน ุฏูุจุงู ฺฉุงุฑ ุฌุฏุฏ ูโุฑู.",
    26: "ุฏูุณุช ุฏุงุฑู ุญุฑู ููุง ุฑู ุฎูุฏู ุจุฒูู.",
    27: "ูู ุงุบูุจ ุจู ุฎูุงุณุชูโูุง ุฎูุฏู ุจโุชูุฌู ูโุดู ุชุง ุตูุญ ุญูุธ ุจุดู.",
    28: "ุงฺฏุฑ ฺฉุณ ุงุฒ ููุงูู ุชุฎุท ฺฉููุ ูุงุฑุงุญุช ูโุดู.",
    29: "ฺฉูฺฉ ฺฉุฑุฏู ุจู ุฏฺฏุฑุงู ุจูู ุญุณ ุงุฑุฒุดููุฏ ูโุฏู.",
    30: "ูู ููุดู ูโุฎูุงู ุจูุชุฑู ูุณุฎูโ ุฎูุฏู ุจุงุดู.",
    31: "ฺฏุงู ุฏูู ูโุฎูุงุฏ ุจุฏูู ูุถุงูุช ุงุญุณุงุณุงุชู ุฑู ุจุฑูุฒ ุจุฏู.",
    32: "ูู ุจู ุชููุง ูุงุฒ ุฏุงุฑู ุชุง ุงูฺฉุงุฑู ุฑู ุจุฑุฑุณ ฺฉูู.",
    33: "ุงฺฏุฑ ุญุณ ฺฉูู ฺฉุณ ูุงูุทูุฆู ุง ูุงูพุงุฏุงุฑูุ ูุถุทุฑุจ ูโุดู.",
    34: "ูู ุจุฑุง ุชุฌุฑุจูโูุง ุฌุฏุฏ ุฎู ูุฌุงูโุฒุฏู ูโุดู.",
    35: "ุงฺฏุฑ ฺฉุณ ุจุฎูุงุฏ ููู ูุญุฏูุฏ ฺฉููุ ููุงุจูู ูโฺฉูู.",
    36: "ูู ุจุฑุง ุญูุธ ุขุฑุงูุดุ ุงุฒ ูุฎุงููุช ุจุง ุฏฺฏุฑุงู ูพุฑูุฒ ูโฺฉูู.",
    37: "ูู ุงุฒ ุงูุชูุงุฏ ุณุงุฒูุฏู ุงุณุชูุจุงู ูโฺฉูู ฺูู ูโุฎูุงู ูพุดุฑูุช ฺฉูู.",
    38: "ุจุฑุง ูู ูููู ฺฉู ุฏฺฏุฑุงู ูุงุฑุงุญุช ูุดูุ ุญุช ุงฺฏุฑ ุฎูุฏู ุงุฐุช ุดู.",
    39: "ูู ููุดู ุณุน ูโฺฉูู ุฎูุฏู ุฑู ฺฉุงุฑุขูุฏ ูุดูู ุจุฏู.",
    40: "ุงุญุณุงุณุงุช ุนูู ุจุฑุง ูู ุงููุช ุฒุงุฏ ุฏุงุฑู.",
    41: "ูู ุณุน ูโฺฉูู ูุจู ุงุฒ ุนููุ ููู ุฌูุงูุจ ุฑู ุชุญูู ฺฉูู.",
    42: "ูู ฺฏุงู ุฏุฑ ุชุตููโฺฏุฑ ูุฑุฏุฏ ูโูููู.",
    43: "ูู ุจุฑูุงููโุฑุฒ ูฺฉุฑุฏู ุฑู ูฺฏุฑุงูโฺฉููุฏู ูโุฏููู.",
    44: "ูู ุงฺฏุฑ ูุงุฒู ุจุงุดูุ ูุงุทุน ู ุตุฑุญ ุญุฑู ูโุฒูู.",
    45: "ูู ูุนูููุงู ุชูุงุด ูโฺฉูู ุงุฒ ุฏุฑฺฏุฑ ุฏูุฑ ุจููููุ ุญุช ุงฺฏุฑ ุญุฑู ุจุฑุง ฺฏูุชู ุฏุงุดุชู ุจุงุดู."
}


def calculate_enneagram_scores(user_answers: dict):
    from collections import defaultdict

    scores = defaultdict(int)
    count = defaultdict(int)

    for q_num, score in user_answers.items():
        # ุชูพ ูุฑุจูุท ุจู ุงู ุณูุงู
        type_num = ((q_num - 1) % 9) + 1
        scores[type_num] += score
        count[type_num] += 1

    # ูุญุงุณุจู ุฏุฑุตุฏ ุชุทุงุจู
    percentages = {
        t: round((scores[t] / (count[t] * 5)) * 100)
        for t in scores
    }

    dominant_type = max(percentages, key=percentages.get)

    return {
        "scores": dict(scores),
        "percentages": percentages,
        "dominant_type": dominant_type
    }




class AdvancedEnneagram(StatesGroup):
    intro = State()             # ูุฑูุฏ ุจู ุชุณุช
    answering = State()         # ุฏุฑ ุญุงู ูพุงุณุฎ ุฏุงุฏู ุจู ุณูุงูุงุช
    finished = State()          # ุงุชูุงู ุชุณุช

def answer_scale_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=str(i), callback_data=f"adv_ans_{i}") for i in range(1, 6)]
    ])


@router.callback_query(F.data == "enneagram_advanced")
async def start_advanced(callback: CallbackQuery, state: FSMContext):
    await state.set_state(AdvancedEnneagram.answering)
    await state.update_data(current_q=1, answers={})

    q_text = advanced_enneagram_questions[1]
    await callback.message.answer(
        f"ุณูุงู ฑ ุงุฒ ดต:\n\n{q_text}",
        reply_markup=answer_scale_keyboard()
    )


@router.callback_query(F.data.startswith("adv_ans_"), AdvancedEnneagram.answering)
async def handle_advanced_answer(callback: CallbackQuery, state: FSMContext):
    data = await state.get_data()
    current_q = data["current_q"]
    answers = data["answers"]

    # ุงุณุชุฎุฑุงุฌ ูพุงุณุฎ
    score = int(callback.data.split("_")[2])
    answers[current_q] = score

    # ุณูุงู ุจุนุฏ
    next_q = current_q + 1
    if next_q <= 45:
        await state.update_data(current_q=next_q, answers=answers)
        q_text = advanced_enneagram_questions[next_q]

        await callback.message.edit_text(
            f"ุณูุงู {next_q} ุงุฒ ดต:\n\n{q_text}",
            reply_markup=answer_scale_keyboard()
        )
    else:
        await state.set_state(AdvancedEnneagram.finished)
        await state.update_data(answers=answers)
        await show_advanced_result(callback, answers)



def get_advanced_result(type_num: int, match_percent: int, health_level: str = "ูุงูุดุฎุต") -> str:
    results = {
        1: {
            "title": "๐ฏ ุชูพ ุบุงูุจ ุดูุง: ุชูพ ฑ - ฺฉูุงูโฺฏุฑุง (The Reformer)",
            "analysis": """ุดูุง ูุฑุฏ ุจุง ูุฌุฏุงูุ ุงุตููโฺฏุฑุง ู ูุณุฆููุชโูพุฐุฑ ูุณุชุฏ. ุงุญุชูุงูุงู ุจู ุงุณุชุงูุฏุงุฑุฏูุง ุจุงูุง ุจุฑุง ุฎูุฏุชูู ู ุฏฺฏุฑุงู ูพุงุจูุฏุฏ ู ุญุณ ูโฺฉูุฏ ุจุงุฏ ุฌูุงู ุฑู ุจู ุฌุง ุจูุชุฑ ุชุจุฏู ฺฉูุฏ. ูุนูููุงู ุงุฒ ุจโุนุฏุงูุชุ ุจโูุธู ุง ุจโุงุฎูุงู ูุงุฑุงุญุช ูโุดุฏ ู ุณุน ูโฺฉูุฏ ููุด ุงุตูุงุญโฺฏุฑ ุฏุงุดุชู ุจุงุดุฏ.""",
            "growth": """โ ุงุฏ ุจฺฏุฑุฏ ุจู ุชูุงุด ุจุฑุง ฺฉูุงู ู ูพุฐุฑุด ููุตโูุง ุชุนุงุฏู ุจุฑูุฑุงุฑ ฺฉูุฏ  
โ ุฏุฑ ูุญุธู ุฒูุฏฺฏ ฺฉูุฏุ ูู ููุท ุฏุฑ ุขูุฏูโ ุขุฑูุงู  
โ ฺฏุงู ุงุฒ ุฏุฏ ุดูุฎ ุจู ููุตโูุง ูฺฏุงู ฺฉูุฏ ุชุง ุงุฒ ูุดุงุฑ ุฏุฑูู ุจฺฉุงูุฏ""",
            "wings": """๐ ุชูพโูุง ูุฒุฏฺฉ ุดูุง:
- ุจุงู ฺูพ (w9): ุขุฑุงูโุชุฑุ ุตูุญโุฌูุชุฑุ ุฏุฑููโฺฏุฑุงุชุฑ  
- ุจุงู ุฑุงุณุช (w2): ฺฏุฑูโุชุฑุ ุญูุงุชฺฏุฑุ ฺฉูฺฉโุฑุณุงู"""
        },
        2: {
            "title": "๐ฏ ุชูพ ุบุงูุจ ุดูุง: ุชูพ ฒ - ุงุฑโฺฏุฑ (The Helper)",
            "analysis": """ุดูุง ูุฑุฏ ุฏูุณูุฒุ ููุนโุฏูุณุช ู ุชูุฌูโฺฏุฑ ูุณุชุฏ ฺฉู ูุนูููุงู ุจู ูุงุฒูุง ุฏฺฏุฑุงู ุงููุช ุฒุงุฏ ูโุฏุฏ. ุจูโุงุญุชูุงู ุฒุงุฏุ ฺฉูฺฉ ฺฉุฑุฏู ุจู ุงุทุฑุงูุงู ุจุฑุงุชูู ุงุฑุฒุดููุฏ ู ุญุช ููุชโุณุงุฒู. ูู ฺฏุงู ููฺฉูู ุฎูุงุณุชูโูุง ุฎูุฏุชูู ุฑู ูุงุฏุฏู ุจฺฏุฑุฏ ุชุง ููุฑุฏ ูพุฐุฑุด ูุฑุงุฑ ุจฺฏุฑุฏ.""",
            "growth": """โ ุงุฏ ุจฺฏุฑุฏ ุฎูุงุณุชูโูุง ุดุฎุต ุฎูุฏุชูู ุฑู ูู ุฌุฏ ุจฺฏุฑุฏ  
โ ูุฑุฒ ุณุงูู ุจู ฺฉูฺฉ ู ูุฏุงฺฉุงุฑ ุงูุฑุงุท ุจุณุงุฒุฏ  
โ ุจุฑุง ฺฉูฺฉ ฺฉุฑุฏู ุงูู ูุทูุฆู ุจุดุฏ ูุงูุนุงู ุงุฒุชูู ุฎูุงุณุชู ุดุฏู""",
            "wings": """๐ ุชูพโูุง ูุฒุฏฺฉ ุดูุง:
- ุจุงู ฺูพ (w1): ุงุตููโฺฏุฑุงุชุฑุ ุณุงุฎุชุงุฑโุชุฑ  
- ุจุงู ุฑุงุณุช (w3): ุฌุงูโุทูุจโุชุฑุ ุงุฌุชูุงุนโุชุฑ"""
        },
        3: {
            "title": "๐ฏ ุชูพ ุบุงูุจ ุดูุง: ุชูพ ณ - ููููุชโฺฏุฑุง (The Achiever)",
            "analysis": """ุดูุง ูุฑุฏ ูุฏูโูุญูุฑุ ุจุงุงูุฑฺ ู ุงูู ุฑูุงุจุช ูุณุชุฏ. ุชูุงู ุฏุงุฑุฏ ุชุตูุฑ ูููู ุงุฒ ุฎูุฏุชูู ุงุฑุงุฆู ุจุฏุฏ ู ุฏุณุชุงูุฑุฏ ุจุฑุงุชูู ุจุณุงุฑ ุจุงุงุฑุฒุดู. ุงุญุชูุงูุงู ุฏุฑ ุดุฑุงุท ุฑูุงุจุช ุฑุดุฏ ูโฺฉูุฏ ุงูุง ฺฏุงู ููฺฉูู ุฎูุฏ ูุงูุนโุชูู ุฑู ูุฑุงููุด ฺฉูุฏ.""",
            "growth": """โ ุณุน ฺฉูุฏ ุจู ุฏุณุชุงูุฑุฏ ู ููุช ุดุฎุต ุชูุงุฒ ูุงุฆู ุจุดุฏ  
โ ุงุฒ ูพุฐุฑุด ุดฺฉุณุช ูุชุฑุณุฏุ ฺฏุงู ุดฺฉุณุช ุฑุงู ุฑุดุฏ ูุงูุนู  
โ ุจู ุฌุง ุธุงูุฑุ ุฑู ุงุญุณุงุณุงุช ุฏุฑูู ูู ุชูุฑฺฉุฒ ฺฉูุฏ""",
            "wings": """๐ ุชูพโูุง ูุฒุฏฺฉ ุดูุง:
- ุจุงู ฺูพ (w2): ฺฏุฑูโุชุฑ ู ูุฑุฏูโุฏุงุฑุชุฑ  
- ุจุงู ุฑุงุณุช (w4): ุฎูุงูโุชุฑ ู ุงุญุณุงุณโุชุฑ"""
        },
        4: {
            "title": "๐ฏ ุชูพ ุบุงูุจ ุดูุง: ุชูพ ด - ููุฑููุฏ / ูุฑุฏฺฏุฑุง (The Individualist)",
            "analysis": """ุดูุง ูุฑุฏ ุงุญุณุงุณุ ููุญุตุฑุจูโูุฑุฏ ู ุฎูุงู ูุณุชุฏ. ุชูุงู ุฏุงุฑุฏ ุนูู ุงุญุณุงุณุงุช ุฑู ุชุฌุฑุจู ฺฉูุฏ ู ุจุง ุชูุงูุชโูุงุชูู ุดูุงุฎุชู ุจุดุฏ. ฺฏุงู ููฺฉูู ุฏฺุงุฑ ุญุณ ุบู ุง ููุงุณู ุจุง ุฏฺฏุฑุงู ุจุดุฏ ู ุงุญุณุงุณ ุฎุงุตโุจูุฏู ุง ูุจูุฏู ุฑู ุชุฌุฑุจู ฺฉูุฏ.""",
            "growth": """โ ุฎูุฏุช ุฑู ุจุง ุฏฺฏุฑุงู ููุงุณู ูฺฉูุ ุฑุดุฏุช ููุญุตุฑ ุจู ูุฑุฏู  
โ ุจู ุฌุง ุบุฑู ุดุฏู ุฏุฑ ุงุญุณุงุณุงุชุ ุจุฑูู ุงุฒ ุฐูู ูู ุญุถูุฑ ุฏุงุดุชู ุจุงุด  
โ ุฎูุงูุชุช ุฑู ุฏุฑ ุฌูุช ูุซุจุชโุณุงุฒ ุฒูุฏฺฏ ุงุณุชูุงุฏู ฺฉู""",
            "wings": """๐ ุชูพโูุง ูุฒุฏฺฉ ุดูุง:
- ุจุงู ฺูพ (w3): ูพุฑุงูุฑฺโุชุฑ ู ููููุชโุทูุจ  
- ุจุงู ุฑุงุณุช (w5): ุชุญููโฺฏุฑุชุฑุ ุฏุฑููโฺฏุฑุงุชุฑ"""
        },
        5: {
            "title": "๐ฏ ุชูพ ุบุงูุจ ุดูุง: ุชูพ ต - ูุชูฺฉุฑ (The Investigator)",
            "analysis": """ุดูุง ูุฑุฏ ุชุญููโฺฏุฑุ ฺฉูุฌฺฉุงู ู ุนุงุดู ุงุฏฺฏุฑ ูุณุชุฏ. ุฏูุง ุฏุฑููโุชูู ุบูู ู ูุนูููุงู ุชูุงู ุฏุงุฑุฏ ุงุฒ ุฏูุฑ ูุณุงุฆู ุฑู ุจุฑุฑุณ ฺฉูุฏ. ุงูุง ฺฏุงู ููฺฉูู ุงุญุณุงุณ ฺฉูุจูุฏ ุงูุฑฺ ุง ุชุฑุณ ุงุฒ ูุงุจุณุชฺฏ ุจู ุฏฺฏุฑุงู ุฏุงุดุชู ุจุงุดุฏ.""",
            "growth": """โ ุจู ุฌุง ุนูุจโูุดูุ ฺฏุงู ูู ูุงุฑุฏ ุชุฌุฑุจู ูุงูุน ุจุดู  
โ ุจุง ุฏฺฏุฑุงู ุงุฑุชุจุงุท ูุงูุน ู ุงูุณุงู ุจุณุงุฒุ ูู ููุท ูฺฉุฑ  
โ ุงุทูุงุนุงุช ุฑู ุจุฑุง ุนููโฺฉุฑุฏู ุงุณุชูุงุฏู ฺฉูุ ูู ููุท ุฐุฎุฑู ฺฉุฑุฏู""",
            "wings": """๐ ุชูพโูุง ูุฒุฏฺฉ ุดูุง:
- ุจุงู ฺูพ (w4): ุงุญุณุงุณโุชุฑุ ููุฑโุชุฑ  
- ุจุงู ุฑุงุณุช (w6): ูุณุฆููุชโูพุฐุฑุชุฑุ ูุญุชุงุทโุชุฑ"""
        },
        6: {
            "title": "๐ฏ ุชูพ ุบุงูุจ ุดูุง: ุชูพ ถ - ููุงุฏุงุฑ (The Loyalist)",
            "analysis": """ุดูุง ูุฑุฏ ููุงุฏุงุฑุ ุชุญููโฺฏุฑ ู ุฏุบุฏุบูโููุฏ ูุณุชุฏ. ูุนูููุงู ุจู ุงููุช ู ุซุจุงุช ุงููุช ูโุฏุฏ ู ุจูโุณุฎุช ุจู ุฏฺฏุฑุงู ุงุนุชูุงุฏ ฺฉุงูู ูโฺฉูุฏ. ุฏุฑ ุจุญุฑุงูโูุง ูโุชููุฏ ููุจุน ุงุนุชูุงุฏ ู ูพุดุชุจุงู ุจุงุดุฏ ุงูุง ฺฏุงู ุฏฺุงุฑ ุงุถุทุฑุงุจ ุจุด ุงุฒ ุญุฏ ูโุดุฏ.""",
            "growth": """โ ุงุนุชูุงุฏ ุจู ููุณ ุฑู ุจุง ุชุฌุฑุจูโูุง ุชุฏุฑุฌ ุจุณุงุฒ  
โ ูฺฏุฑุงู ุฑู ุชุจุฏู ุจู ุจุฑูุงููโุฑุฒ ูุซุจุช ฺฉู  
โ ุจู ุบุฑุฒูโุงุช ูู ุงุนุชูุงุฏ ฺฉูุ ูู ููุท ุชุฑุณโูุง""",
            "wings": """๐ ุชูพโูุง ูุฒุฏฺฉ ุดูุง:
- ุจุงู ฺูพ (w5): ูฺฉุฑโุชุฑุ ูุญุงูุธูโฺฉุงุฑุชุฑ  
- ุจุงู ุฑุงุณุช (w7): ูุงุฌุฑุงุฌูุชุฑุ ูพุฑุงูุฑฺโุชุฑ"""
        },
        7: {
            "title": "๐ฏ ุชูพ ุบุงูุจ ุดูุง: ุชูพ ท - ุฎูุดโฺฏุฐุฑุงู / ูุดุชุงู (The Enthusiast)",
            "analysis": """ุดูุง ูุฑุฏ ุฎูุดโุจูุ ูพุฑุงูุฑฺ ู ูุงุฌุฑุงุฌู ูุณุชุฏ. ุฏูุณุช ุฏุงุฑุฏ ุชุฌุฑุจูโูุง ุฌุฏุฏ ุฏุงุดุชู ุจุงุดุฏ ู ุงุฒ ฺฉููุงุฎุช ูุฑุงุฑ ูโฺฉูุฏ. ุงูุง ฺฏุงู ููฺฉูู ุงุฒ ุชุฑุณ ูุงุฑุงุญุช ุง ุฑูุฌุ ุฎูุฏุชูู ุฑู ุฏุฑ ุณุฑฺฏุฑูโูุง ุบุฑู ฺฉูุฏ.""",
            "growth": """โ ุจุง ูุฌุงู ุฒูุฏฺฏ ุฏุฑ ูุญุธู ุจุงุดุ ูู ุงุฒ ุนูู ุงุญุณุงุณุงุชุช ูู ูุฑุงุฑ ูฺฉู  
โ ุจู ุฌุง ูุฑุงุฑ ุงุฒ ุฏุฑุฏุ ุงูู ุฑู ุจูพุฐุฑ ู ุงุฏ ุจฺฏุฑ  
โ ุจู ูุณุฆููุชโูุงุช ูพุงุจูุฏ ุจููู ุชุง ุฑุดุฏุช ฺฉุงููโุชุฑ ุดู""",
            "wings": """๐ ุชูพโูุง ูุฒุฏฺฉ ุดูุง:
- ุจุงู ฺูพ (w6): ููุงุฏุงุฑุชุฑุ ูุชุนูุฏุชุฑ  
- ุจุงู ุฑุงุณุช (w8): ููโุชุฑุ ุจุงุงุฑุงุฏูโุชุฑ"""
        },
        8: {
            "title": "๐ฏ ุชูพ ุบุงูุจ ุดูุง: ุชูพ ธ - ูุงุทุน / ุฑูุจุฑ (The Challenger)",
            "analysis": """ุดูุง ูุฑุฏ ูุฏุฑุชููุฏุ ูุณุชูู ู ุงูู ุงูุฏุงู ูุณุชุฏ. ุงุฒ ุขุณุจโูพุฐุฑ ูพุฑูุฒ ูโฺฉูุฏ ู ุชูุงู ุฏุงุฑุฏ ุฎูุฏุชูู ู ุงุทุฑุงูุงูโุชูู ุฑู ูู ูฺฏู ุฏุงุฑุฏ. ุฏุฑ ุจุญุฑุงูโูุง ุฑูุจุฑ ุฎูุจ ุฏุงุฑุฏ ุงูุง ฺฏุงู ููฺฉูู ฺฉูุชุฑูโฺฏุฑ ุง ุชูุงุฌู ุจุดุฏ.""",
            "growth": """โ ุขุณุจโูพุฐุฑ ุฑู ุถุนู ูุฏููุ ูุฏุฑุช ูุงูุน ุฏุฑ ุตุฏุงูุชู  
โ ุฏฺฏุฑุงู ุฑู ุดุฑฺฉ ุจุฏููุ ูู ุฑูุจ  
โ ฺฉูุชุฑู ุฒุงุฏ ฺฏุงู ุจุงุนุซ ูุงุตูู ฺฏุฑูุชู ุขุฏูโูุง ูโุดู""",
            "wings": """๐ ุชูพโูุง ูุฒุฏฺฉ ุดูุง:
- ุจุงู ฺูพ (w7): ูุงุฌุฑุงุฌูุชุฑุ ูพุฑุชุญุฑฺฉโุชุฑ  
- ุจุงู ุฑุงุณุช (w9): ุขุฑุงูโุชุฑุ ููุนุทูโุชุฑ"""
        },
        9: {
            "title": "๐ฏ ุชูพ ุบุงูุจ ุดูุง: ุชูพ น - ุตูุญโุฌู (The Peacemaker)",
            "analysis": """ุดูุง ูุฑุฏ ุขุฑุงูุ ูพุฐุฑุง ู ููุงููฺฏโุทูุจ ูุณุชุฏ. ุงุฒ ุฏุฑฺฏุฑ ุฏูุฑ ูโฺฉูุฏ ู ุจู ุฏูุจุงู ุงุฌุงุฏ ุตูุญ ุฏุฑ ุงุทุฑุงู ุฎูุฏุชูู ูุณุชุฏ. ุงูุง ฺฏุงู ููฺฉูู ูุงุฒูุง ุดุฎุตโุชูู ุฑู ูุงุฏุฏู ุจฺฏุฑุฏ ุชุง ููุงููฺฏ ุญูุธ ุจุดู.""",
            "growth": """โ ุงุฏ ุจฺฏุฑ ูู ุจฺฏุ ูุธุฑ ุชู ูู ูููู  
โ ุงุฒ ูุฑุงุฑ ุงุฒ ุฏุฑฺฏุฑ ุจู ุณูุช ููุงุฌูู ุณุงูู ุญุฑฺฉุช ฺฉู  
โ ุงูุฑฺโุช ุฑู ุตุฑู ุฎูุงุณุชูโูุง ูุงูุนโุช ฺฉูุ ูู ููุท ุณุงุฒฺฏุงุฑ""",
            "wings": """๐ ุชูพโูุง ูุฒุฏฺฉ ุดูุง:
- ุจุงู ฺูพ (w8): ูุงุทุนโุชุฑุ ุจุงุงุฑุงุฏูโุชุฑ  
- ุจุงู ุฑุงุณุช (w1): ุงุตููโฺฏุฑุงุชุฑุ ุจุงูุฌุฏุงูโุชุฑ"""
        }
    }

    data = results.get(type_num)
    if not data:
        return "โ ุชูพ ุดูุง ุดูุงุณุง ูุดุฏ. ูุทูุงู ุชุณุช ุฑุง ูุฌุฏุฏ ุงูุฌุงู ุฏูุฏ."

    return (
        f"{data['title']}\n"
        f"๐ ุฏุฑุตุฏ ุชุทุงุจู: {match_percent}ูช\n\n"
        f"๐งฌ ุชุญูู ุงุฒ ุดุฎุตุช ุดูุง:\n\n"
        f"{data['analysis']}\n\n"
        f"๐งญ ูุณุฑ ุฑุดุฏ ูพุดููุงุฏ ุจุฑุง ุดูุง:\n\n"
        f"{data['growth']}\n\n"
        f"{data['wings']}\n\n"
        f"๐ ุณุทุญ ุณูุงูุช ุดูุง ุฏุฑ ุญุงู ุญุงุถุฑ: {health_level}\n"
        f"(ุจุฑุงุณุงุณ ูพุงุณุฎโูุง ุดูุง ุจู ุณุคุงูุงุช ูุฑุจูุท ุจู ฺฉูุชุฑูุ ุงุณุชุฑุณ ู ุฎูุฏุงูุชูุงุฏ)\n\n"
        f"โจ ูุชุฌู ุงู ุชุณุช ุตุฑูุงู ุขุบุงุฒ ฺฉ ุณูุฑูุ ูู ูพุงุงูุด."
    )



async def show_advanced_result(callback: CallbackQuery, answers: dict):
    result = calculate_enneagram_scores(answers)
    dominant = result["dominant_type"]
    percent = result["percentages"][dominant]

    # ูุนูุงู ุณุทุญ ุณูุงูุช ุซุงุจุช (ูโุชููู ุจุนุฏุงู ููุดููุฏ ฺฉูู)
    health = "ูุชูุณุท ุฑู ุจู ุจุงูุง"

    final_text = get_advanced_result(
        type_num=dominant,
        match_percent=percent,
        health_level=health
    )

    await callback.message.edit_text(final_text)
